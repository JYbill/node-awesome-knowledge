# MongoDB æƒå¨æŒ‡å—(ç¬¬ä¸‰ç‰ˆ)

## ç¬¬äºŒç«  å…¥é—¨æŒ‡å—

### æ–‡æ¡£

1. é”®ä¸­ä¸èƒ½å«æœ‰`\0`ï¼ˆç©ºå­—ç¬¦ï¼‰ã€‚è¿™ä¸ªå­—ç¬¦ç”¨äºè¡¨ç¤ºä¸€ä¸ªé”®çš„ç»“æŸ
2. `.`å’Œ`$`æ˜¯ç‰¹æ®Šå­—ç¬¦ï¼Œåªèƒ½åœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨(å¯ä»¥è®¤ä¸ºè¿™ä¸¤ä¸ªå­—ç¬¦å±äºä¿ç•™å­—ç¬¦)
3. å­—æ®µåŒºåˆ†å¤§å°å†™ï¼Œä¸”ä¸å…è®¸é‡å¤

```ts
// ä¸‹é¢ä¸¤ä¸ªæ–‡æ¡£æ˜¯ä¸åŒçš„
{"count" : 5}
{"Count" : 5}
// é‡å¤ä¸åˆæ³•âŒ
{"greeting" : "Hello, world!", "greeting" : "Hello, MongoDB!"}
```

### é›†åˆ

é›†åˆï¼šç›¸å½“äºå…³ç³»å‹æ•°æ®åº“çš„è¡¨

1. é›†åˆåç§°ä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²("")ã€ç©ºå­—ç¬¦(\0)
2. é›†åˆåç§°ä¸èƒ½ä»¥`system.`å¼€å¤´ï¼Œè¯¥å‰ç¼€æ˜¯ä¸ºå†…éƒ¨é›†åˆä¿ç•™çš„ã€‚

> ğŸŒ° ä¾‹å¦‚ï¼Œ`system.users`é›†åˆä¸­ä¿å­˜ç€æ•°æ®åº“çš„ç”¨æˆ·ï¼Œ`system.namespaces`é›†åˆä¸­ä¿å­˜ç€æœ‰å…³æ•°æ®åº“æ‰€æœ‰é›†åˆçš„ä¿¡æ¯

3. ç”¨æˆ·åˆ›å»ºçš„é›†åˆåç§°ä¸­ä¸åº”åŒ…å«ä¿ç•™å­—ç¬¦`$`

> ğŸŒ° æŸäº›ç”±ç³»ç»Ÿç”Ÿæˆçš„é›†åˆä¼šåŒ…å«å®ƒï¼Œé™¤éä½ è¦è®¿é—®çš„æ˜¯è¿™äº›é›†åˆä¹‹ä¸€ï¼Œå¦åˆ™ä¸åº”åœ¨åç§°ä¸­ä½¿ç”¨`$`å­—ç¬¦

### åç§°ç©ºé—´

- `åç§°ç©ºé—´`ï¼šå°†æ•°æ®åº“åç§°ä¸å…¶ä¸­çš„é›†åˆåè¿èµ·æ¥ï¼Œå¯ä»¥è·å¾—ä¸€ä¸ªå®Œå…¨é™å®šçš„é›†åˆåç§°

```ts
// å¦‚æœä½ è¦ä½¿ç”¨cmsæ•°æ®åº“ä¸­çš„blog.postsé›†åˆ
// åˆ™è¯¥é›†åˆçš„å‘½åç©ºé—´ä¸ºï¼š
cms.blog.posts;
```

> ğŸ’¡ å‘½åç©ºé—´çš„é•¿åº¦é™åˆ¶ä¸º 120 å­—èŠ‚ï¼Œè€Œå®é™…ä½¿ç”¨æ—¶åº”è¯¥å°äº 100 å­—èŠ‚

### shell

- shellï¼šæ˜¯ä¸€ä¸ª JavaScript è§£é‡Šå™¨ï¼Œèƒ½å¤Ÿè¿è¡Œä»»æ„çš„ JavaScript ç¨‹åº

```ts
Math.sin(Math.PI / 2); // 1
"hello mongodb!".repeat(2); // hello mongodb!hello mongodb!
```

- å®šä¹‰æ–¹æ³•

```ts
function double(num) {
  return num ** 2;
}
double(10); // 100
```

### åŸºæœ¬æ•°æ®ç±»å‹

1. null

2. boolean

3. æ•°å€¼ç±»å‹

   1. `æµ®ç‚¹æ•°`ï¼šé»˜è®¤ä½¿ç”¨ 64 ä½æµ®ç‚¹æ•°æ¥è¡¨ç¤ºæ•°å€¼

   ```ts
   {"x" : 3.14}
   {"x" : 3}
   ```

   2. å¯¹äºæ•´æ•°ï¼šå¯ä»¥ä½¿ç”¨`NumberInt`æˆ–`NumberLong`ç±»ï¼Œå®ƒä»¬åˆ†åˆ«è¡¨ç¤º 4 å­—èŠ‚å’Œ 8 å­—èŠ‚çš„æœ‰ç¬¦å·æ•´æ•°

   ```ts
   {"x" : NumberInt("3")} // 4å­—èŠ‚å¤§å°æ•´æ•°ï¼Œ3
   {"x" : NumberLong("3")} // 8å­—èŠ‚å¤§å°æ•´æ•°ï¼Œ3
   ```

4. å­—ç¬¦ä¸²ï¼šUTF8 å­—ç¬¦ä¸²

5. æ—¥æœŸç±»å‹ï¼šå­˜å‚¨ä¸º 64 ä½æ•´æ•°ï¼Œè¡¨ç¤ºè‡ª Unix çºªå…ƒï¼ˆ1970 å¹´ 1 æœˆ 1 æ—¥ï¼‰ä»¥æ¥çš„`æ¯«ç§’æ•°`ï¼Œä¸åŒ…å«æ—¶åŒºä¿¡æ¯

6. æ­£åˆ™è¡¨è¾¾å¼ï¼šä¸ JS çš„æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•ç›¸åŒ

```ts
{"x" : /foobar/i}
```

7. æ•°ç»„
8. å†…åµŒæ–‡æ¡£/å¯¹è±¡

```ts
{
  "x" : {
    "foo" : "bar"
  }
}
```

9. ObjectIDï¼šæ˜¯ä¸€ä¸ª 12 å­—èŠ‚çš„ IDï¼Œæ˜¯æ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†

```ts
{"x": ObjectId()}
// {"x": ObjectId("636cd7a9e5a4c73cfd0eaee7")}
// ç”¨24ä¸ªåå…­è¿›åˆ¶æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²æ¥è¡¨ç¤ºï¼Œæ¯2ä¸ªæ•°å­—å 1ä¸ªå­—èŠ‚ï¼Œæ€»å…±å¤§å°ä¸º12å­—èŠ‚

// ObjectIdç”ŸæˆåŸç†
1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  |  10  |  11  |  12  ï½œ
          æ—¶é—´æˆ³      |           éšæœºå€¼             | è®¡æ•°å™¨ï¼ˆèµ·å§‹å€¼éšæœºï¼‰
// [1, 4]å­—èŠ‚çš„æ—¶é—´æˆ³å’Œ[5, 9]éšæœºå€¼ä¸º1så†…æä¾›äº†å”¯ä¸€æ€§
// [1, 4]å­—èŠ‚çš„æ—¶é—´æˆ³éšå«äº†æ–‡æ¡£åˆ›å»ºæ—¶é—´
// æœ€åä¸‰å­—èŠ‚ï¼šæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä»¥ä¸€ä¸ªéšæœºæ•°ä½œä¸ºèµ·å§‹å€¼ï¼Œç”¨æ¥é¿å…åˆ†å¸ƒå¼ä¸»é”®å†²çªé—®é¢˜
```

10. äºŒè¿›åˆ¶ï¼šæ˜¯ä»»æ„å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œä¸èƒ½é€šè¿‡ shell æ“ä½œï¼›å¦‚æœè¦å°†é UTF-8 å­—ç¬¦ä¸²å­˜å…¥æ•°æ®åº“ï¼Œé‚£ä¹ˆä½¿ç”¨äºŒè¿›åˆ¶æ•°æ®æ˜¯å”¯ä¸€çš„æ–¹æ³•ã€‚
11. ä»£ç ï¼šå­˜å‚¨ JS ä»£ç 

```ts
{"x" : function() { /* ... */ }}
```

### å¢åˆ æ”¹æŸ¥

- æ’å…¥

```ts
// æ’å…¥æ•°æ®
db.é›†åˆ.insertOne({"key": "value"});
db.é›†åˆ.insertMany([{}, {}, ...], { ordered: true}); // é»˜è®¤ä¸ºtrue

// orderedå‚æ•°
// ä¸ºfalseæ—¶ï¼Œå…è®¸MongoDBé‡æ–°æ’åˆ—æ’å…¥çš„é¡ºåºä»¥æé«˜æ€§èƒ½ï¼Œå¦‚æœæ’å…¥å‘ç”Ÿé”™è¯¯ï¼Œä¼šå°è¯•æ’å…¥æ‰€æœ‰æ–‡æ¡£
// é»˜è®¤trueæ—¶ï¼ŒæŒ‰é¡ºåºæ’å…¥ï¼Œå¦‚æœæ’å…¥å‘ç”Ÿé”™è¯¯ï¼Œä¹‹åçš„æ–‡æ¡£å‡ä¸ä¼šè¢«æ’å…¥é›†åˆä¸­
db.test.insertMany([
  {_id: 1, uname: "xqv", age: 24, job: "nodejs", workAge: 2},
  {_id: 1, uname: "å¼ ä¸‰", age: 20, job: "å‰ç«¯å¼€å‘", workAge: 0},
  {_id: 2, uname: "å°é’è›™", age: 24, job: "nodejså…¨æ ˆ", workAge: 1},
], { ordered: false });
// ç¬¬1ã€3æ¡ä¼šæˆåŠŸæ’å…¥
```

- åˆ é™¤

```js
db.collection.deleteOne(query); // åˆ é™¤ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å†…å®¹
db.collection.deleteMany(query); // åˆ é™¤æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„å†…å®¹

// åˆ é™¤å½“å‰é›†åˆä¸‹çš„æ‰€æœ‰æ–‡æ¡£
db.collection.deleteMany({});
```

- æ›´æ–°

> âš ï¸ `æ›´æ–°æ–‡æ¡£æ˜¯åŸå­æ“ä½œ`ï¼šå¦‚æœä¸¤ä¸ªæ›´æ–°åŒæ—¶å‘ç”Ÿï¼Œå…ˆåˆ°è¾¾æœåŠ¡å™¨çš„æ›´æ–°ä¼šå…ˆè¢«æ‰§è¡Œï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªæ›´æ–°

```js
db.collection.replaceOne(query, replaceQuery); // é€‚åˆæŒ‡å®šæ–‡æ¡£è¦†ç›–ï¼Œå…è®¸ä¿®æ”¹_idä½†ä¸æ¨è
db.test.replaceOne({ _id: 1 }, { name: "replaceOne" });
// {_id: 1, uname: "xqv", age: 24, job: "nodejs", workAge: 2}
// {_id: 1, name: "replaceOne"}

db.collection.updateOne(query, updateQuery, [options]);
db.collection.updateMany(query, updateQuery, [options]);
// upsert?: é»˜è®¤falseï¼Œä¸å­˜åœ¨queryæ•°æ®æ˜¯å¦æ’å…¥updateQueryæ•°æ®
```

> âš ï¸ updateOneã€updateMany æ›´æ–°ã€åˆ é™¤å¿…é¡»ä½¿ç”¨$æ“ä½œç¬¦ï¼Œå¦åˆ™æŠ¥é”™

- `$set: {field: value}`å¦‚æœå­˜åœ¨å³æ›´æ–°ï¼Œä¸å­˜åˆ™æ·»åŠ 
- `$unset: {field: 1}`åˆ é™¤è¯¥ field å­—æ®µï¼Œä¸å­˜åœ¨å¿½ç•¥ï¼Œå­˜åœ¨åˆ é™¤è¯¥å­—æ®µ

```ts
db.test.updateOne({ _id: 3 }, { $set: { family: { son: "his son." } } });
db.test.updateOne({ _id: 3 }, { $set: { "family.son": "test." } }); // åµŒå¥—å†™æ³•
db.test.updateOne({ _id: 3 }, { $unset: { family: 1 } });
```

- `$inc: {field: 1}`ï¼šä¸å­˜åœ¨çš„å­—æ®µä¼šåˆ›å»ºï¼ŒæŒ‡å®šæ•°å­—ç±»å‹å­—æ®µè‡ªå¢ 1ï¼Œå†å› ä¸ºåŸå­æ€§æ‰€ä»¥é€‚åˆå¼ºä¸€è‡´çš„è‡ªå¢ï¼Œåœºæ™¯ï¼šæŠ•ç¥¨ã€é¢„è§ˆæ•°

```ts
db.test.updateOne({ _id: 3 }, { $inc: { age: 1 } });
// {_id: 3, uname: "å¼ ä¸‰", age: 20, job: "å‰ç«¯å¼€å‘", workAge: 0},
// {_id: 3, uname: "å¼ ä¸‰", age: 21, job: "å‰ç«¯å¼€å‘", workAge: 0},
```

> âš ï¸ `"$inc"` åªèƒ½ç”¨äº`æ•´å‹NumberInt`ã€`é•¿æ•´å‹NumberLong`æˆ–`åŒç²¾åº¦æµ®ç‚¹å‹(é»˜è®¤æ•°å­—)`çš„å€¼ï¼Œå…¶ä»–ç±»å‹éƒ½ä¼šé”™è¯¯

### æ•°ç»„æ“ä½œ

#### $pull/$push/...

- $pushï¼šå­˜åœ¨å­—æ®µï¼Œå‘æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ ï¼›ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ•°ç»„å¹¶æ·»åŠ 
  - `$each`ä¿®é¥°ç¬¦ï¼šåœ¨ä¸€æ¬¡æ“ä½œä¸­æ·»åŠ å¤šä¸ªå€¼
  - `$slice`ä¿®é¥°ç¬¦ï¼šé˜²æ­¢æ•°ç»„å­—æ®µå¢é•¿è¶…è¿‡æŸä¸ªå¤§å°ï¼Œè¶…å‡ºåƒé˜Ÿåˆ—ä¸€æ ·å…ˆè¿›å…ˆå‡ºï¼ˆé…åˆ$each ä¿®é¥°ç¬¦ä½¿ç”¨ï¼‰
  - `$sort`ä¿®é¥°ç¬¦ï¼šå¯¹æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ æ’åºï¼Œ1 å‡åºï¼Œ-1 é™åºï¼ˆé…åˆ$each ä¿®é¥°ç¬¦ä½¿ç”¨ï¼‰

```ts
// {_id: 3, uname: "å¼ ä¸‰", age: 20, job: "å‰ç«¯å¼€å‘", workAge: 0},

db.test.updateOne({ _id: 3 }, { $push: { color: "orange" } });
// {_id: 3, ..., color: ["orange"]},

db.test.updateOne({ _id: 3 }, { $push: { color: "red" } });
// {_id: 3, ..., color: ["orange", "red"]},

// ä½¿ç”¨$eachã€$sliceä¿®é¥°ç¬¦ã€‚è¶…å‡ºåæŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼Œæœ€å…ˆç§»é™¤"orange"
db.test.updateOne(
  { _id: 3 },
  {
    $push: {
      color: { $each: ["black", "white"], $slice: -3 },
    },
  }
);
// {_id: 3, ..., color: ["red", "black", "white"]},

// $eachã€$sliceã€$sortå¯¹æ’åºåçš„ç»“æœè¿›è¡Œåˆ‡å‰²é™åˆ¶
// { _id: 3, color: [{source: 1}, {source: 2}] }
db.test.updateOne(
  { _id: 3 },
  {
    $push: {
      color: {
        $each: [{ source: 3 }, { source: 4 }], // æ’å…¥3ã€4
        $slice: -3, // é™åˆ¶åªèƒ½æœ‰ä¸‰ä¸ªï¼Œå…ˆè¿›å…ˆå‡º
        $sort: { source: -1 }, // å¯¹æ‰€æœ‰å€¼å…ˆé™åºæ’åˆ— -> åˆ‡å‰² -> æ’å…¥
      },
    },
  }
);
// { _id: 3, color: [{source: 3}, {source: 2}, {source: 1}]}
```

- $pull: åˆ é™¤æ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ ï¼Œå¦‚æœæœ‰å¤šä¸ªåˆ™åˆ é™¤æ•°ç»„ä¸­æ‰€æœ‰ç›¸åŒçš„æŒ‡å®šå…ƒç´ 

  ```js
  this.#Live.updateOne(
    {
      _id: "id",
    },
    {
      $pull: { playList: "id" },
    }
  );
  ```

- $popï¼šä»ä»»æ„ä¸€ç«¯åˆ é™¤å…ƒç´ 

```ts
// {"todo" : ["dishes", "laundry", "dry cleaning"]}
db.lists.updateOne({}, { $pop: { todo: 1 } }); // æœ«å°¾åˆ é™¤ä¸€ä¸ªå…ƒç´ 
db.lists.updateOne({}, { $pop: { todo: -1 } }); // å¤´éƒ¨åˆ é™¤ä¸€ä¸ªå…ƒç´ 
```

- $addToSet:å‘æ•°ç»„å­—æ®µä¸­æ·»åŠ ä¹‹å‰ä¸å­˜åœ¨çš„å…ƒç´ 
  - `$each`ä¿®é¥°ç¬¦ï¼šåœ¨ä¸€æ¬¡æ“ä½œä¸­æ·»åŠ å¤šä¸ªå…ƒç´ ï¼Œé‡å¤çš„å…ƒç´ ä¸ä¼šè¿½åŠ 

```ts
{
  $addToSet: {
    arrayField: value,
  }
}
```

- $pushAll: æ–°å¢å¤šä¸ªå¯¹è±¡åˆ°æ•°ç»„åº•éƒ¨
- $pullAll: åœ¨æ•°ç»„ä¸­åˆ é™¤åŒ¹é…åˆ°æ‰€æœ‰å€¼

#### $å®šä½è¿ç®—ç¬¦

- åŸºäºæ•°ç»„ç´¢å¼•æ›´æ”¹

```ts
db.test.updateOne(
  { _id: ObjectId("64001e0f3714e80566cdf216") },
  { $set: { "comments.0.uname": "åŸºäºä¸‹æ ‡æ›´æ”¹" } }
);
```
