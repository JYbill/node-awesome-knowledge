# MongoDB æƒå¨æŒ‡å—(ç¬¬ä¸‰ç‰ˆ)

## ç¬¬äºŒç«  å…¥é—¨æŒ‡å—

### æ–‡æ¡£

1. é”®ä¸­ä¸èƒ½å«æœ‰`\0`ï¼ˆç©ºå­—ç¬¦ï¼‰ã€‚è¿™ä¸ªå­—ç¬¦ç”¨äºè¡¨ç¤ºä¸€ä¸ªé”®çš„ç»“æŸ
2. `.`å’Œ`$`æ˜¯ç‰¹æ®Šå­—ç¬¦ï¼Œåªèƒ½åœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨(å¯ä»¥è®¤ä¸ºè¿™ä¸¤ä¸ªå­—ç¬¦å±äºä¿ç•™å­—ç¬¦)
3. å­—æ®µåŒºåˆ†å¤§å°å†™ï¼Œä¸”ä¸å…è®¸é‡å¤

```ts
// ä¸‹é¢ä¸¤ä¸ªæ–‡æ¡£æ˜¯ä¸åŒçš„
{"count" : 5}
{"Count" : 5}
// é‡å¤ä¸åˆæ³•âŒ
{"greeting" : "Hello, world!", "greeting" : "Hello, MongoDB!"}
```

### é›†åˆ

é›†åˆï¼šç›¸å½“äºå…³ç³»å‹æ•°æ®åº“çš„è¡¨

1. é›†åˆåç§°ä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²("")ã€ç©ºå­—ç¬¦(\0)
2. é›†åˆåç§°ä¸èƒ½ä»¥`system.`å¼€å¤´ï¼Œè¯¥å‰ç¼€æ˜¯ä¸ºå†…éƒ¨é›†åˆä¿ç•™çš„ã€‚

> ğŸŒ° ä¾‹å¦‚ï¼Œ`system.users`é›†åˆä¸­ä¿å­˜ç€æ•°æ®åº“çš„ç”¨æˆ·ï¼Œ`system.namespaces`é›†åˆä¸­ä¿å­˜ç€æœ‰å…³æ•°æ®åº“æ‰€æœ‰é›†åˆçš„ä¿¡æ¯

3. ç”¨æˆ·åˆ›å»ºçš„é›†åˆåç§°ä¸­ä¸åº”åŒ…å«ä¿ç•™å­—ç¬¦`$`

> ğŸŒ° æŸäº›ç”±ç³»ç»Ÿç”Ÿæˆçš„é›†åˆä¼šåŒ…å«å®ƒï¼Œé™¤éä½ è¦è®¿é—®çš„æ˜¯è¿™äº›é›†åˆä¹‹ä¸€ï¼Œå¦åˆ™ä¸åº”åœ¨åç§°ä¸­ä½¿ç”¨`$`å­—ç¬¦

### åç§°ç©ºé—´

- `åç§°ç©ºé—´`ï¼šå°†æ•°æ®åº“åç§°ä¸å…¶ä¸­çš„é›†åˆåè¿èµ·æ¥ï¼Œå¯ä»¥è·å¾—ä¸€ä¸ªå®Œå…¨é™å®šçš„é›†åˆåç§°

```ts
// å¦‚æœä½ è¦ä½¿ç”¨cmsæ•°æ®åº“ä¸­çš„blog.postsé›†åˆ
// åˆ™è¯¥é›†åˆçš„å‘½åç©ºé—´ä¸ºï¼š
cms.blog.posts;
```

> ğŸ’¡ å‘½åç©ºé—´çš„é•¿åº¦é™åˆ¶ä¸º 120 å­—èŠ‚ï¼Œè€Œå®é™…ä½¿ç”¨æ—¶åº”è¯¥å°äº 100 å­—èŠ‚

### shell

- shellï¼šæ˜¯ä¸€ä¸ª JavaScript è§£é‡Šå™¨ï¼Œèƒ½å¤Ÿè¿è¡Œä»»æ„çš„ JavaScript ç¨‹åº

```ts
Math.sin(Math.PI / 2); // 1
"hello mongodb!".repeat(2); // hello mongodb!hello mongodb!
```

- å®šä¹‰æ–¹æ³•

```ts
function double(num) {
  return num ** 2;
}
double(10); // 100
```

### åŸºæœ¬æ•°æ®ç±»å‹

1. null

2. boolean

3. æ•°å€¼ç±»å‹

   1. `æµ®ç‚¹æ•°`ï¼šé»˜è®¤ä½¿ç”¨ 64 ä½æµ®ç‚¹æ•°æ¥è¡¨ç¤ºæ•°å€¼

   ```ts
   {"x" : 3.14}
   {"x" : 3}
   ```

   2. å¯¹äºæ•´æ•°ï¼šå¯ä»¥ä½¿ç”¨`NumberInt`æˆ–`NumberLong`ç±»ï¼Œå®ƒä»¬åˆ†åˆ«è¡¨ç¤º 4 å­—èŠ‚å’Œ 8 å­—èŠ‚çš„æœ‰ç¬¦å·æ•´æ•°

   ```ts
   {"x" : NumberInt("3")} // 4å­—èŠ‚å¤§å°æ•´æ•°ï¼Œ3
   {"x" : NumberLong("3")} // 8å­—èŠ‚å¤§å°æ•´æ•°ï¼Œ3
   ```

4. å­—ç¬¦ä¸²ï¼šUTF8 å­—ç¬¦ä¸²

5. æ—¥æœŸç±»å‹ï¼šå­˜å‚¨ä¸º 64 ä½æ•´æ•°ï¼Œè¡¨ç¤ºè‡ª Unix çºªå…ƒï¼ˆ1970 å¹´ 1 æœˆ 1 æ—¥ï¼‰ä»¥æ¥çš„`æ¯«ç§’æ•°`ï¼Œä¸åŒ…å«æ—¶åŒºä¿¡æ¯

6. æ­£åˆ™è¡¨è¾¾å¼ï¼šä¸ JS çš„æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•ç›¸åŒ

```ts
{"x" : /foobar/i}
```

7. æ•°ç»„
8. å†…åµŒæ–‡æ¡£/å¯¹è±¡

```ts
{
  "x" : {
    "foo" : "bar"
  }
}
```

9. ObjectIDï¼šæ˜¯ä¸€ä¸ª 12 å­—èŠ‚çš„ IDï¼Œæ˜¯æ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†

```ts
{"x": ObjectId()}
// {"x": ObjectId("636cd7a9e5a4c73cfd0eaee7")}
// ç”¨24ä¸ªåå…­è¿›åˆ¶æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²æ¥è¡¨ç¤ºï¼Œæ¯2ä¸ªæ•°å­—å 1ä¸ªå­—èŠ‚ï¼Œæ€»å…±å¤§å°ä¸º12å­—èŠ‚

// ObjectIdç”ŸæˆåŸç†
1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  |  10  |  11  |  12  ï½œ
          æ—¶é—´æˆ³      |           éšæœºå€¼             | è®¡æ•°å™¨ï¼ˆèµ·å§‹å€¼éšæœºï¼‰
// [1, 4]å­—èŠ‚çš„æ—¶é—´æˆ³å’Œ[5, 9]éšæœºå€¼ä¸º1så†…æä¾›äº†å”¯ä¸€æ€§
// [1, 4]å­—èŠ‚çš„æ—¶é—´æˆ³éšå«äº†æ–‡æ¡£åˆ›å»ºæ—¶é—´
// æœ€åä¸‰å­—èŠ‚ï¼šæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä»¥ä¸€ä¸ªéšæœºæ•°ä½œä¸ºèµ·å§‹å€¼ï¼Œç”¨æ¥é¿å…åˆ†å¸ƒå¼ä¸»é”®å†²çªé—®é¢˜
```

10. äºŒè¿›åˆ¶ï¼šæ˜¯ä»»æ„å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œä¸èƒ½é€šè¿‡ shell æ“ä½œï¼›å¦‚æœè¦å°†é UTF-8 å­—ç¬¦ä¸²å­˜å…¥æ•°æ®åº“ï¼Œé‚£ä¹ˆä½¿ç”¨äºŒè¿›åˆ¶æ•°æ®æ˜¯å”¯ä¸€çš„æ–¹æ³•ã€‚
11. ä»£ç ï¼šå­˜å‚¨ JS ä»£ç 

```ts
{"x" : function() { /* ... */ }}
```

## ç¬¬ä¸‰ç«  åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤æ–‡æ¡£

### å¢åˆ æ”¹æŸ¥

- æ’å…¥

```ts
// æ’å…¥æ•°æ®
db.é›†åˆ.insertOne({"key": "value"});
db.é›†åˆ.insertMany([{}, {}, ...], { ordered: true}); // é»˜è®¤ä¸ºtrue

// orderedå‚æ•°
// ä¸ºfalseæ—¶ï¼Œå…è®¸MongoDBé‡æ–°æ’åˆ—æ’å…¥çš„é¡ºåºä»¥æé«˜æ€§èƒ½ï¼Œå¦‚æœæ’å…¥å‘ç”Ÿé”™è¯¯ï¼Œä¼šå°è¯•æ’å…¥æ‰€æœ‰æ–‡æ¡£
// é»˜è®¤trueæ—¶ï¼ŒæŒ‰é¡ºåºæ’å…¥ï¼Œå¦‚æœæ’å…¥å‘ç”Ÿé”™è¯¯ï¼Œä¹‹åçš„æ–‡æ¡£å‡ä¸ä¼šè¢«æ’å…¥é›†åˆä¸­
db.test.insertMany([
  {_id: 1, uname: "xqv", age: 24, job: "nodejs", workAge: 2},
  {_id: 1, uname: "å¼ ä¸‰", age: 20, job: "å‰ç«¯å¼€å‘", workAge: 0},
  {_id: 2, uname: "å°é’è›™", age: 24, job: "nodejså…¨æ ˆ", workAge: 1},
], { ordered: false });
// ç¬¬1ã€3æ¡ä¼šæˆåŠŸæ’å…¥
```

- åˆ é™¤

```js
db.collection.deleteOne(query); // åˆ é™¤ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å†…å®¹
db.collection.deleteMany(query); // åˆ é™¤æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„å†…å®¹

// åˆ é™¤å½“å‰é›†åˆä¸‹çš„æ‰€æœ‰æ–‡æ¡£
db.collection.deleteMany({});
```

- æ›´æ–°

> âš ï¸ `æ›´æ–°æ–‡æ¡£æ˜¯åŸå­æ“ä½œ`ï¼šå¦‚æœä¸¤ä¸ªæ›´æ–°åŒæ—¶å‘ç”Ÿï¼Œå…ˆåˆ°è¾¾æœåŠ¡å™¨çš„æ›´æ–°ä¼šå…ˆè¢«æ‰§è¡Œï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªæ›´æ–°

```js
db.collection.replaceOne(query, replaceQuery); // é€‚åˆæŒ‡å®šæ–‡æ¡£è¦†ç›–ï¼Œå…è®¸ä¿®æ”¹_idä½†ä¸æ¨è
db.test.replaceOne({ _id: 1 }, { name: "replaceOne" });
// {_id: 1, uname: "xqv", age: 24, job: "nodejs", workAge: 2}
// {_id: 1, name: "replaceOne"}

db.collection.updateOne(query, updateQuery, [options]);
db.collection.updateMany(query, updateQuery, [options]);
// upsert?: é»˜è®¤falseï¼Œä¸å­˜åœ¨queryæ•°æ®æ˜¯å¦æ’å…¥updateQueryæ•°æ®
```

> âš ï¸ updateOneã€updateMany æ›´æ–°ã€åˆ é™¤å¿…é¡»ä½¿ç”¨$æ“ä½œç¬¦ï¼Œå¦åˆ™æŠ¥é”™

- `$set: {field: value}`å¦‚æœå­˜åœ¨å³æ›´æ–°ï¼Œä¸å­˜åˆ™æ·»åŠ 
- `$unset: {field: 1}`åˆ é™¤è¯¥ field å­—æ®µï¼Œä¸å­˜åœ¨å¿½ç•¥ï¼Œå­˜åœ¨åˆ é™¤è¯¥å­—æ®µ

```ts
db.test.updateOne({ _id: 3 }, { $set: { family: { son: "his son." } } });
db.test.updateOne({ _id: 3 }, { $set: { "family.son": "test." } }); // åµŒå¥—å†™æ³•
db.test.updateOne({ _id: 3 }, { $unset: { family: 1 } });
```

- `$inc: {field: 1}`ï¼šä¸å­˜åœ¨çš„å­—æ®µä¼šåˆ›å»ºï¼ŒæŒ‡å®šæ•°å­—ç±»å‹å­—æ®µè‡ªå¢ 1ï¼Œå†å› ä¸ºåŸå­æ€§æ‰€ä»¥é€‚åˆå¼ºä¸€è‡´çš„è‡ªå¢ï¼Œåœºæ™¯ï¼šæŠ•ç¥¨ã€é¢„è§ˆæ•°

```ts
db.test.updateOne({ _id: 3 }, { $inc: { age: 1 } });
// {_id: 3, uname: "å¼ ä¸‰", age: 20, job: "å‰ç«¯å¼€å‘", workAge: 0},
// {_id: 3, uname: "å¼ ä¸‰", age: 21, job: "å‰ç«¯å¼€å‘", workAge: 0},
```

> âš ï¸ `"$inc"` åªèƒ½ç”¨äº`æ•´å‹NumberInt`ã€`é•¿æ•´å‹NumberLong`æˆ–`åŒç²¾åº¦æµ®ç‚¹å‹(é»˜è®¤æ•°å­—)`çš„å€¼ï¼Œå…¶ä»–ç±»å‹éƒ½ä¼šé”™è¯¯

### æ•°ç»„æ“ä½œ

#### $pull/$push/...

- $pushï¼šå­˜åœ¨å­—æ®µï¼Œå‘æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ ï¼›ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ•°ç»„å¹¶æ·»åŠ 
  - `$each`ä¿®é¥°ç¬¦ï¼šåœ¨ä¸€æ¬¡æ“ä½œä¸­æ·»åŠ å¤šä¸ªå€¼
  - `$slice`ä¿®é¥°ç¬¦ï¼šé˜²æ­¢æ•°ç»„å­—æ®µå¢é•¿è¶…è¿‡æŸä¸ªå¤§å°ï¼Œè¶…å‡ºåƒé˜Ÿåˆ—ä¸€æ ·å…ˆè¿›å…ˆå‡ºï¼ˆé…åˆ$each ä¿®é¥°ç¬¦ä½¿ç”¨ï¼‰
  - `$sort`ä¿®é¥°ç¬¦ï¼šå¯¹æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ æ’åºï¼Œ1 å‡åºï¼Œ-1 é™åºï¼ˆé…åˆ$each ä¿®é¥°ç¬¦ä½¿ç”¨ï¼‰

```ts
// {_id: 3, uname: "å¼ ä¸‰", age: 20, job: "å‰ç«¯å¼€å‘", workAge: 0},

db.test.updateOne({ _id: 3 }, { $push: { color: "orange" } });
// {_id: 3, ..., color: ["orange"]},

db.test.updateOne({ _id: 3 }, { $push: { color: "red" } });
// {_id: 3, ..., color: ["orange", "red"]},

// ä½¿ç”¨$eachã€$sliceä¿®é¥°ç¬¦ã€‚è¶…å‡ºåæŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼Œæœ€å…ˆç§»é™¤"orange"
db.test.updateOne(
  { _id: 3 },
  {
    $push: {
      color: { $each: ["black", "white"], $slice: -3 },
    },
  }
);
// {_id: 3, ..., color: ["red", "black", "white"]},

// $eachã€$sliceã€$sortå¯¹æ’åºåçš„ç»“æœè¿›è¡Œåˆ‡å‰²é™åˆ¶
// { _id: 3, color: [{source: 1}, {source: 2}] }
db.test.updateOne(
  { _id: 3 },
  {
    $push: {
      color: {
        $each: [{ source: 3 }, { source: 4 }], // æ’å…¥3ã€4
        $slice: -3, // é™åˆ¶åªèƒ½æœ‰ä¸‰ä¸ªï¼Œå…ˆè¿›å…ˆå‡º
        $sort: { source: -1 }, // å¯¹æ‰€æœ‰å€¼å…ˆé™åºæ’åˆ— -> åˆ‡å‰² -> æ’å…¥
      },
    },
  }
);
// { _id: 3, color: [{source: 3}, {source: 2}, {source: 1}]}
```

- $pull: åˆ é™¤æ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ ï¼Œå¦‚æœæœ‰å¤šä¸ªåˆ™åˆ é™¤æ•°ç»„ä¸­æ‰€æœ‰ç›¸åŒçš„æŒ‡å®šå…ƒç´ 

  ```js
  this.#Live.updateOne(
    {
      _id: "id",
    },
    {
      $pull: { playList: "id" },
    }
  );
  ```

- $popï¼šä»ä»»æ„ä¸€ç«¯åˆ é™¤å…ƒç´ 

```ts
// {"todo" : ["dishes", "laundry", "dry cleaning"]}
db.lists.updateOne({}, { $pop: { todo: 1 } }); // æœ«å°¾åˆ é™¤ä¸€ä¸ªå…ƒç´ 
db.lists.updateOne({}, { $pop: { todo: -1 } }); // å¤´éƒ¨åˆ é™¤ä¸€ä¸ªå…ƒç´ 
```

- $addToSet:å‘æ•°ç»„å­—æ®µä¸­æ·»åŠ ä¹‹å‰ä¸å­˜åœ¨çš„å…ƒç´ 
  - `$each`ä¿®é¥°ç¬¦ï¼šåœ¨ä¸€æ¬¡æ“ä½œä¸­æ·»åŠ å¤šä¸ªå…ƒç´ ï¼Œé‡å¤çš„å…ƒç´ ä¸ä¼šè¿½åŠ 

```ts
{
  $addToSet: {
    arrayField: value,
  }
}
```

- $pushAll: æ–°å¢å¤šä¸ªå¯¹è±¡åˆ°æ•°ç»„åº•éƒ¨
- $pullAll: åœ¨æ•°ç»„ä¸­åˆ é™¤åŒ¹é…åˆ°æ‰€æœ‰å€¼

#### $å®šä½è¿ç®—ç¬¦

- åŸºäºæ•°ç»„ç´¢å¼•æ›´æ”¹

```ts
db.test.updateOne(
  { _id: ObjectId("64001e0f3714e80566cdf216") },
  { $set: { "comments.0.uname": "åŸºäºä¸‹æ ‡æ›´æ”¹" } }
);
```

- `$`å®šä½è¿ç®—ç¬¦ï¼šåªä¼šæ›´æ–°ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„æ•°ç»„å…ƒç´ 

  ```ts
  // æ¡ˆä¾‹1: ä¿®æ”¹æ•°ç»„ä¸­æŒ‡å®šå­—æ®µçš„å€¼
  {
    _id: 4,
    grades: [
       { grade: 80, mean: 75, std: 8 },
       { grade: 85, mean: 90, std: 5 },
       { grade: 90, mean: 85, std: 3 }
    ]
  }

  // æ›´æ–°gradeå€¼ä¸º85çš„æ–‡æ¡£çš„stdå­—æ®µçš„å€¼ä¸º6
  db.students.update(
     { _id: 4, "grades.grade": 85 },
     { $set: { "grades.$.std" : 6 } }
  )

  // æ¡ˆä¾‹2: åªæ˜¾ç¤ºæ•°ç»„ä¸­æŸäº›å…ƒç´ 
  { "_id" : 1, "semester" : 1, "grades" : [ 70, 87, 90 ] }
  { "_id" : 2, "semester" : 1, "grades" : [ 90, 90, 92 ] }
  { "_id" : 3, "semester" : 1, "grades" : [ 85, 100, 90 ] }
  db.students.find({
    semester: 1,
    grades: { $eq: 90 }
  },
  {
    "grades.$": 1
  })
  { "_id" : 1, "grades" : [ 90 ] }
  { "_id" : 2, "grades" : [ 90 ] } //æ³¨æ„è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯è¯¥æ–‡æ¡£çš„ç¬¬ä¸€ä¸ª90
  { "_id" : 3, "grades" : [ 90 ] }

  // æ¡ˆä¾‹3: åªæ›´æ–°æŸ¥è¯¢åˆ°çš„ç¬¬ä¸€ä¸ªæ•°ç»„å…ƒç´ çš„å€¼
  db.students.update({semester: 1, grades:90},{$set:{"grades.$":95}},
                     {multi:false} // æ›´æ–°å¤šæ¡å…³é—­ï¼Œåªæ›´æ–°ç¬¬ä¸€ä¸ª
                    );
  { "_id" : 1, "semester" : 1, "grades" : [ 70, 87, 95 ] } // åªæ›´æ–°äº†è¯¥æ¡æ•°æ®ä¸­çš„90 -> 95
  { "_id" : 2, "semester" : 1, "grades" : [ 90, 90, 92 ] }
  { "_id" : 3, "semester" : 1, "grades" : [ 85, 100, 90 ] }
  ```

  - `$[identifier]æ•°ç»„è¿‡æ»¤å™¨`ï¼šç”¨äºæ›´æ–°å•ä¸ªæ•°ç»„å…ƒç´ çš„é€‰é¡¹`arrayFilters`ï¼Œv mongodb 3.6.0+

  ```ts
  // ğŸŒ°æ¡ˆä¾‹ä¸€ï¼šæ‰€æœ‰>=100çš„å…ƒç´ å…¨éƒ¨ä¿®æ”¹ä¸º100
  [
    { "_id" : 1, "grades" : [ 95, 92, 90 ] },
    { "_id" : 2, "grades" : [ 98, 100, 102 ] },
    { "_id" : 3, "grades" : [ 95, 110, 100 ] }
  ]

  db.test.update({},
    { $set: { "grades.$[elem]":100 } }, // grades>=100çš„å…ƒç´ å…¨éƒ¨ä¿®æ”¹ä¸º100
    {
      multi:true,
      arrayFilters:[{"elem":{$gte:100}}]
    }
  )
  /*
    { "_id" : 1, "grades" : [95, 92, 90] },
    { "_id" : 2, "grades" : [98, 100, 100] },
    { "_id" : 3, "grades" : [95, 100, 100] }
  */





  // ğŸŒ° æ¡ˆä¾‹2:
  // 1. æ»¡è¶³æ–‡æ¡£typeä¸º"quiz"çš„æ‰€æœ‰å…ƒç´ 
  // 2. æ»¡è¶³question.source === 8çš„æ‰€æœ‰å…ƒç´ 
  // 3. æ»¡è¶³ä»¥ä¸Šä¸¤ç‚¹çš„æ‰€æœ‰å…ƒç´ ä¿®æ”¹ä¸º0
  { "_id" : 1,
    "grades" : [
      { type: "quiz", questions: [ 10, 8, 5 ] },
      { type: "quiz", questions: [ 8, 9, 6 ] },
      { type: "hw", questions: [ 5, 8, 3 ] },
      { type: "exam", questions: [ 25, 10, 23, 0 ] },
    ]
  }
  db.student5.update({},
    // æ»¡è¶³grades.t.type: "quiz" && questions.source: 8
    {$set:{"grades.$[t].questions.$[score]":0}},
    // è¿™é‡Œçš„tç›¸å½“äºgrades.t.type
    // sourceç›¸å½“äº [...].questions.score: 8
    {arrayFilters:[{"t.type":"quiz"},{"score":8}]}
  );
  /*
  {
    "_id" : 1,
    "grades" : [
      { "type" : "quiz", "questions" : [10, 0, 5]},
      { "type" : "quiz", "questions" : [0, 9, 6]},
      { "type" : "hw", "questions" : [5, 8, 3]},
      { "type" : "exam", "questions" : [25, 10, 23, 0]}
    ]
  }
  */
  ```

## ç¬¬å››ç«  æŸ¥è¯¢

### 4.2.2 OR æŸ¥è¯¢

> ğŸ’¡ è™½ç„¶æ€»æ˜¯å¯ä»¥ä½¿ç”¨`"$or"`ï¼Œä½†åªè¦æœ‰å¯èƒ½å°±åº”è¯¥ä½¿ç”¨`"$in"`æŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥æ›´é«˜æ•ˆåœ°å¯¹å…¶è¿›è¡Œå¤„ç†

### 4.2.3 $not

- åŒ¹é…çš„ç»“æœå–å

```ts
db.test.find({
  uname: {
    $not: { $eq: "xqv" }, // $notè¦é…åˆå…¶ä»–æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œå¦‚ï¼šç­‰äº$eq
  },
});
// æŸ¥è¯¢uname !== "xqv"çš„å…¶ä»–æ‰€æœ‰ç”¨æˆ·
```

### 4.3.1 $exists

- è¾…åŠ©æŸ¥è¯¢ç¡®è®¤è¯¥é”®å·²å­˜åœ¨

```ts
// æ•°æ®
{uname: "zs", talk: "ä½ å¥½å•Š"},
{uname: "ç©º", talk: null}

// ğŸŒ°ä¾‹å­1ï¼šå¦‚æœæŸ¥è¯¢ä¸å­˜åœ¨çš„keyï¼Œå°†ä¼šæŸ¥åˆ°æ‰€æœ‰æ–‡æ¡£ï¼Œå› ä¸ºæ‰€æœ‰æ–‡æ¡£ç¡®å®ä¸å­˜åœ¨è¯¥key
db.test.find({ aka: null });
/*
	{uname: "zs", talk: "ä½ å¥½å•Š"},
	{uname: "ç©º", talk: null}
*/


// ğŸŒ°ä¾‹å­2ï¼šå¦‚æœåªæƒ³è¦ä¸ºnullçš„æ•°æ®ï¼Œä¸”ä¸å¯ä»¥æŸ¥å‡ºæ²¡æœ‰"talk"å­—æ®µçš„æ–‡æ¡£ï¼Œå°±å¿…é¡»ç”¨åˆ°$exists
db.test.find({
  talk: { $eq: null, $exists: true }
});
/*
	{uname: "ç©º", talk: null}
*/
```

### 4.3.2 æ­£åˆ™è¡¨è¾¾å¼

- $regexï¼šæ­£åˆ™åŒ¹é…

```ts
// æŸ¥è¯¢nameä»¥xå¼€å¤´çš„æ‰€æœ‰
db.user.find({ name: /^x/ });

db.test.find({
  uname: { $regex: /^xqv.*/ },
});

// æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ç±»å‹
db.foo.insertOne({ bar: /baz/ });
db.foo.find({ bar: /baz/ });
// { _id: ...,  bar : /baz/}
```

> ğŸ’¡ å½“**ä½¿ç”¨åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™è¡¨è¾¾å¼æ—¶å¯ä»¥èµ°ç´¢å¼•**ï¼Œå¦‚æœè®¾ç½®äº†`^`å¼€å¤´åŒ¹é…å°†ä¼šåœ¨ä¸€æ¬¡ç¼©å°ç´¢å¼•åŒ¹é…èŒƒå›´ï¼

### 4.3.3 æŸ¥è¯¢æ•°ç»„

- $all æ“ä½œç¬¦ï¼šæ•°ç»„å†…å®¹`å®Œå…¨æ»¡è¶³`æŒ‡å®šçš„åŒ¹é…æ¡ä»¶ï¼Œ`å…ƒç´ é¡ºåº`ä¸ä¼šå½±å“

```ts
// $allçš„ä½¿ç”¨
db.users.find({
  badges:{
    $all:["black","blue"]
  }
}, { "_id":1, badges:1 });

// ç­‰ä»·äº
db.users.find({
  $and:[
    {badges:"blue"},
    {badges:"black"}
  ]
}, { "_id":1, badges:1 });
// æŸ¥è¯¢ç»“æœï¼šä¸è€ƒè™‘å…ƒç´ é¡ºåºï¼Œåªè¦éƒ½åŒ…å«å°±æ»¡è¶³
{ "_id" : 1, "badges" : [ "blue", "black" ] }
{ "_id" : 6, "badges" : [ "black", "blue" ] }
```

- `$size`ï¼šè¿”å›æ»¡è¶³ size é•¿åº¦çš„æ•°ç»„çš„æ–‡æ¡£ï¼Œä½†æ˜¯æ— æ³•ä¸å…¶ä»–æ¡ä»¶è¿ç®—ç¬¦ä¸€èµ·ä½¿ç”¨(å¦‚ï¼š$gt)

```ts
db.collection.find({
  field: { $size: 2 },
});
```

- `$slice`ï¼šåˆ‡å‰²éœ€è¦è¿”å›çš„æ•°ç»„å­—æ®µï¼Œ-1 æœ€åä¸€æ¡ï¼Œ1 ç¬¬ä¸€æ¡ï¼Œå…è®¸æŒ‡å®šä¸­é—´åŒºé—´

```ts
// è·å–å€’æ•°ç¬¬ä¸€æ¡
db.test.find(
  {},
  {
    comments: { $slice: -1 },
  }
);

// ç¬¬äºŒæ¡å¼€å§‹è·å–ä¸€æ¡
db.test.find(
  {},
  {
    comments: { $slice: [1, 1] },
  }
);
```

- æ•°ç»„èŒƒå›´æŸ¥è¯¢çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

```ts
// ğŸŒ°ä¾‹å­ï¼šå½“å­—æ®µå³æ˜¯æ•°ç»„åˆæ˜¯æ•°ç±»å‹æ—¶
{"x" : 5}
{"x" : 15}
{"x" : 25}
{"x" : [5, 25]}
db.test.find({"x" : {"$gt" : 10, "$lt" : 20}})
/*
	{"x" : 15}
	{"x" : [5, 25]}
 */

// è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨$elemMatchæŸ¥æ•°ç»„
// db.test.find({"x" : {"$elemMatch" : {"$gt" : 10, "$lt" : 20}}})
// è§£å†³æ–¹æ¡ˆäºŒï¼šç´¢å¼• + min() + max()æŸ¥æ•°å­—
// db.test.find({"x" : {"$gt" : 10, "$lt" : 20}}).min({"x" : 10}).max({"x" : 20})
// è§£å†³æ–¹æ¡ˆä¸‰ï¼šä¸å…è®¸å‡ºç°å­—æ®µå¯¹åº”ç±»å‹ä¸ä¸€è‡´çš„åœºæ™¯ï¼ğŸ‘
```

- æ•°ç»„åµŒå¥—æŸ¥è¯¢

```js
// æ–‡æ¡£
"title" : "Raiders of the Lost Ark" ,
"filming locations" : [
    { "city": "Los Angeles", "state": "CA", "country": "USA" },
    { "city": "Rome", "state": "Lazio", "country": "Italy" },
    { "city": "Florence", "state": "sc", "country": "USA"}
]
db.user.find({ "from.city": "Rome" }) // âœ…åŒ¹é…[{..., city: "Rome",...}]çš„æ–‡æ¡£ï¼Œå…è®¸å¤šæˆ–å°‘å­—æ®µ
db.user.find({ from: {city: "Rome"} }) // âŒåªä¼šåŒ¹é…[{city: "Rome"}]çš„æ–‡æ¡£ï¼Œå¤šå­—æ®µã€å°‘å­—æ®µéƒ½åŒ¹é…ä¸åˆ°
```

> âš ï¸ ä¸Šé¢æ•°ç»„åµŒå¥—æŸ¥è¯¢ï¼Œå½“æŸ¥è¯¢ä¸º`find({ æ¡ä»¶1, æ¡ä»¶2 })`æ—¶ï¼Œæ­¤æ—¶æ¡ä»¶ = æ¡ä»¶ 1 || æ¡ä»¶ 2ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ»¡è¶³æ•°ç»„æ˜¯ï¼Œæ¡ä»¶ = æ¡ä»¶ 1 && æ¡ä»¶ 2 æ—¶ï¼Œéœ€è¦ä½¿ç”¨`$elemMatch`æ“ä½œç¬¦

- æŸ¥è¯¢æ•°ç»„å…ƒç´ æ»¡è¶³å¤šä¸ªæ¡ä»¶

```js
// æ•°ç»„ä¸­æœ‰ä¸€ä¸ªå…ƒç´ æ»¡è¶³å³å¯
db.user.find({
  "from.city": "Rome",
  "from.country": "Italy",
});

// æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ å¿…é¡»å…¨éƒ¨æ»¡è¶³
db.user.find({
  $elemMatch: { city: "Rome", country: "Italy" },
});
```

### 4.4 $where

- $whereï¼šå®ƒå…è®¸ä½ åœ¨æŸ¥è¯¢ä¸­æ‰§è¡Œä»»æ„çš„ JS ä»£ç ã€‚å‡½æ•°è¿”å›`true`ï¼Œæ–‡æ¡£å°±ä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†è¿”å›ï¼›å¦‚æœå‡½æ•°è¿”å›`false`ï¼Œæ–‡æ¡£å°±ä¸è¿”å›

> âš ï¸ ç¦æ­¢ç»ˆç«¯ç”¨æˆ·éšæ„ä½¿ç”¨`$where`å­å¥

```ts
// æŸ¥è¯¢ï¼šroleå­—æ®µé•¿åº¦å¤§äº0 && roleå­—æ®µç±»å‹ä¸æ˜¯"å­—ç¬¦ä¸²"ç±»å‹çš„æ–‡æ¡£
db.users.find({
  $where: "this.role.length > 0 && typeof this.role !== 'string'",
});
```

- $where æ¯”æ™®é€šæŸ¥è¯¢æ…¢å¾—å¤šçš„åŸå› 

1. æ¯ä¸ªæ–‡æ¡£éƒ½å¿…é¡»ä» BSON è½¬æ¢ä¸º JS å¯¹è±¡ï¼Œç„¶åé€šè¿‡"$where"è¡¨è¾¾å¼è®¡ç®—

2. $whereæ“ä½œæ— æ³•èµ°ç´¢å¼•ï¼Œæ‰€ä»¥åº”è¯¥å°½å¯èƒ½çš„å…ˆç”¨æ¡ä»¶æŸ¥è¯¢èµ°ç´¢å¼•è¿‡æ»¤ï¼Œæœ€åå†ç”¨$where å¯¹ç»“æœå¾®è°ƒ
3. å°½å¯èƒ½ä½¿ç”¨èšåˆæ“ä½œç¬¦$exprè¿ç®—ç¬¦ä»£æ›¿$where æ“ä½œç¬¦

### 4.5 æ¸¸æ ‡

- æ¸¸æ ‡ç”¨æ³•ï¼šåªæœ‰åœ¨`next()`æ—¶æ‰ä¼šæŸ¥è¯¢è·å–å‰ 100 ä¸ªç»“æœæˆ–è€…å‰ 4MB çš„æ•°æ®ï¼ˆä¸¤è€…ä¹‹ä¸­è¾ƒå°è€…ï¼‰ï¼Œåœ¨æ‰€æœ‰æ•°æ®è€—å°½ä¹‹åæ‰ä¼šå†å»æŸ¥è¯¢æ˜¯å¦æœ‰æ›´å¤šçš„æ•°æ®

```ts
const cursor = db.collection.find();
while (cursor.hasNext()) {
  const doc = cursor.next();
  console.log(doc);
}
```

> ğŸ’¡ åº”ç”¨ç¨‹åºä¸­å¦‚æœä¸€å®šè¦ç”¨æ¸¸æ ‡å¤„ç†å¤§æ•°æ®åˆ†é¡µåœºæ™¯ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­ä¿å­˜æ¯ä¸ªç”¨æˆ·å¯¹åº”æ¸¸æ ‡çš„ map é›†åˆï¼Œè¿™æ ·æ¸¸æ ‡æŸ¥è¯¢å†…å®¹å°±ä¸ä¼šæ··ä¹±ï¼›å½“ç„¶å¯ä»¥é€‰æ‹©æ›´å¥½çš„ç”¨è¿‡æ»¤æ¡ä»¶å»åˆ†é¡µ

### 4.5.1 limitã€skip å’Œ sort

#### æ’åº

- `sort({})`: æ ¹æ®å­—æ®µæ’åºï¼Œ1 å‡åºï¼Œ-1 é™åº

```ts
db.users.find({}).sort({
  age: 1, // å…ˆæ ¹æ®ageå­—æ®µå‡åºæ’åˆ—
  name: -1, // ageå­—æ®µç›¸åŒæ—¶ï¼Œå†æŒ‰nameå­—æ®µé™åºæ’åˆ—
});
```

- å¯¹äºä¸€ä¸ªå­—æ®µå¤šç§ç±»å‹æ—¶ï¼Œæœ‰ä¸€ä¸ªé¢„å®šä¹‰çš„æ’åºé¡ºåº

```ts
1. æœ€å°å€¼
2. null
3. æ•°å­—ï¼ˆæ•´å‹ã€é•¿æ•´å‹ã€åŒç²¾åº¦æµ®ç‚¹å‹ã€å°æ•°å‹ï¼‰
4. å­—ç¬¦ä¸²
5. å¯¹è±¡/æ–‡æ¡£
6. æ•°ç»„
7. äºŒè¿›åˆ¶æ•°æ®
8. ObjectId
9. Boolean
10. æ—¥æœŸ
11. æ—¶é—´æˆ³
12. æ­£åˆ™è¡¨è¾¾å¼
13. æœ€å¤§å€¼
```

#### åˆ†é¡µ

- `skip()`ã€`limit()`
- åˆ†é¡µæç¤º: å½“æ•°æ®é‡å¤§æ—¶ï¼Œä¸è¦è½»æ˜“ä½¿ç”¨ skipï¼Œskip æ˜¯æŸ¥å‡ºæ¥åä¸€ä¸ªä¸€ä¸ªè·³è¿‡ï¼Œæœ€åè·å–ç»“æœ

> è§£å†³æ–¹æ¡ˆï¼šåœ¨**æŸ¥è¯¢é˜¶æ®µé¿å…å¤§æ•°æ®é‡**ï¼Œæ”¹ä¸ºæ’åº â• æ¡ä»¶æ¡ä»¶è¿‡æ»¤
>
> ï¼ˆå¦‚ï¼šæ—¶é—´æ’åºï¼Œtime > ä¸Šä¸€æ¬¡æœ€åæ—¶é—´ limit(n)ï¼‰

```ts
// ä½¿ç”¨skip
db.information.find({}).skip(100).limit(20);

// åœ¨æŸ¥è¯¢é˜¶æ®µé¿å…è¯»å–å¤§é‡æ•°æ®
db.information
  .find({
    conversation_id: ObjectId("6397edc27d248ed52ee7750b"),
  })
  .sort({
    createdAt: -1,
  })
  .limit(20);
```

### 4.5.2 ã€€é¿å…ç•¥è¿‡å¤§é‡ç»“æœ

- å¤§æ•°æ®åˆ†é¡µåœºæ™¯ï¼šæ’åº â• æ¡ä»¶æ¡ä»¶è¿‡æ»¤

```ts
// ç¬¬ä¸€æ¬¡ï¼šé™åºæ’åˆ—è·å–20æ¡æ•°æ®
db.users.find({}).limit(20).sort({ createAt: -1 });
// åç»­ï¼šæ ¹æ®ä¸Šä¸€æ¬¡æœ€åä¸€æ¡æ•°æ®çš„createAtå­—æ®µä½œä¸ºæ¡ä»¶ï¼Œè·å–æ¯”å®ƒå¤§çš„20æ¡
const lastCreateAt = request.query.createAt;
db.users
  .find({ createAt: { $gt: lastCreateAt } })
  .limit(20)
  .sort({ createAt: -1 });
```

> ğŸ’¡ åªéœ€ç¡®ä¿æœ‰ä¸€ä¸ªåŒ…å«åˆ›å»ºæ—¶é—´é”®çš„ç´¢å¼•

- è·å–éšæœºæ–‡æ¡£åœºæ™¯ï¼šæ·»åŠ  random å­—æ®µ

```ts
const randomNum = Math.random();
let res = db.users.findOne({ random: { $gt: randomNum } }); // æŸ¥è¯¢å¤§äºéšæœºæ•°å€¼çš„ç¬¬ä¸€ä¸ªéšæœºæ•°ï¼Œä½†æœ‰å¯èƒ½è¿‡å¤§æ²¡æœ‰æ•°æ®
if (res === null) {
  res = db.users.findOne({ random: { $lt: randomNum } });
}
return res;
```

> ğŸ’¡ åªéœ€ç¡®ä¿æœ‰ä¸€ä¸ªåŒ…å«éšæœºé”®çš„ç´¢å¼•

### 4.5.3 ã€€æ¸¸æ ‡ç”Ÿå‘½å‘¨æœŸ

- åœ¨æœåŠ¡å™¨ç«¯ï¼Œæ¸¸æ ‡ä¼šå ç”¨å†…å­˜å’Œèµ„æºã€‚ä¸€æ—¦æ¸¸æ ‡éå†å®Œç»“æœä¹‹åï¼Œæˆ–è€…å®¢æˆ·ç«¯å‘é€ä¸€æ¡æ¶ˆæ¯è¦æ±‚ç»ˆæ­¢ï¼Œæ•°æ®åº“å°±å¯ä»¥é‡Šæ”¾å®ƒæ­£åœ¨ä½¿ç”¨çš„èµ„æºã€‚
- è¿˜æœ‰ä¸€äº›æƒ…å†µå¯èƒ½å¯¼è‡´æ¸¸æ ‡ç»ˆæ­¢ä»¥åŠéšåçš„æ¸…ç†ã€‚å½“æ¸¸æ ‡è¶…å‡ºå®¢æˆ·ç«¯çš„ä½œç”¨åŸŸæ—¶ï¼Œé©±åŠ¨ç¨‹åºä¼šå‘æ•°æ®åº“å‘é€ä¸€æ¡ç‰¹æ®Šçš„æ¶ˆæ¯ï¼Œè®©æ•°æ®åº“çŸ¥é“å®ƒå¯ä»¥â€œæ€æ­»â€è¯¥æ¸¸æ ‡ã€‚æœ€åï¼Œå³ä½¿ç”¨æˆ·æ²¡æœ‰éå†å®Œæ‰€æœ‰ç»“æœè€Œä¸”æ¸¸æ ‡ä»åœ¨ä½œç”¨åŸŸå†…ï¼Œå¦‚æœ 10 åˆ†é’Ÿæ²¡æœ‰è¢«ä½¿ç”¨çš„è¯ï¼Œæ•°æ®åº“æ¸¸æ ‡ä¹Ÿå°†è‡ªåŠ¨â€œé”€æ¯â€ã€‚è¿™æ ·ï¼Œå¦‚æœå®¢æˆ·ç«¯å´©æºƒæˆ–è€…å‡ºé”™ï¼ŒMongoDB å°±ä¸éœ€è¦ç»´æŠ¤ä¸Šåƒä¸ªè¢«æ‰“å¼€çš„æ¸¸æ ‡äº†ã€‚
- æœ‰æ—¶å¯èƒ½çš„ç¡®éœ€è¦ä¸€ä¸ªæ¸¸æ ‡ç»´æŒå¾ˆé•¿æ—¶é—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ã€‚æ³¨æ„ï¼šå¦‚æœå…³é—­äº†æ¸¸æ ‡è¶…æ—¶ï¼Œåˆ™å¿…é¡»éå†å®Œæ‰€æœ‰ç»“æœæˆ–ä¸»åŠ¨å°†å…¶é”€æ¯ä»¥ç¡®ä¿æ¸¸æ ‡è¢«å…³é—­ã€‚å¦åˆ™ï¼Œå®ƒä¼šä¸€ç›´å ç”¨æ•°æ®åº“çš„èµ„æºï¼Œç›´åˆ°æœåŠ¡å™¨é‡æ–°å¯åŠ¨ã€‚

## ç¬¬ 5 ç«  ç´¢å¼•

### 5.1.1 ã€€åˆ›å»ºç´¢å¼•

- **ä½¿ç”¨ç´¢å¼•çš„ä»£ä»·**ï¼šä¿®æ”¹ç´¢å¼•å­—æ®µçš„å†™æ“ä½œï¼ˆæ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ï¼‰ä¼šèŠ±è´¹æ›´é•¿çš„æ—¶é—´ï¼Œä½†æ˜¯å¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯è¿™æ ·çš„ä»£ä»·æ˜¯å®Œå…¨å¯ä»¥æ¥å—çš„å¦‚æœè¿™æ˜¯ä¸€ä¸ªå¾ˆå°‘ç”¨åˆ°çš„æŸ¥è¯¢æˆ–è€…æ˜¯ç”±ç®¡ç†å‘˜æ‰§è¡Œçš„ä¸å¤ªå…³å¿ƒæ—¶é—´æ¶ˆè€—çš„æŸ¥è¯¢ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥åœ¨æ­¤ä¸Šé¢åˆ›å»ºç´¢å¼•ã€‚

> ğŸ’¡ MongoDB ç´¢å¼•çš„å·¥ä½œåŸç†ä¸å…¸å‹çš„å…³ç³»æ•°æ®åº“ç´¢å¼•å‡ ä¹ç›¸åŒ

- æå‰å‡†å¤‡äº† 10w æ¡æ•°æ®

```ts
db.test.find().sort({ index: -1 });
// {_id: ..., age: 37, index: 1000000, username: "user1000000" }
// {_id: ..., age: 0, index: 999999, username: "user999999" }
// ...
```

- æ— ç´¢å¼•è¿›è¡Œæ–‡æ¡£æ‰«æ

```ts
db.test.find({ username: "user6666" }).explain("executionStats");
// å…³é”®ä¿¡æ¯æå–
"executionStats": {
	"nReturned": 1, // è¿”å›ä¸€æ¡æ–‡æ¡£
	"executionTimeMillis": 584, // è€—æ—¶584ms
	"totalDocsExamined": 1000000, // æ‰«ææ–‡æ¡£æ€»æ•°10wæ¡
	"executionStages": {
		"stage": "COLLSCAN" // æ–‡æ¡£æ‰«æ
	}
}
```

- ç»™`username`å­—æ®µåˆ›å»ºç´¢å¼•è¿›è¡Œä¼˜åŒ–

```ts
db.test.createIndex({ username: 1 }, { name: "username_1" });
```

- ç´¢å¼•æŸ¥è¯¢

```ts
db.test.find({ username: "user6666" }).explain("executionStats");
// å…³é”®ä¿¡æ¯æå–
"executionStats": {
	"nReturned": 1, // è¿”å›ä¸€æ¡æ–‡æ¡£
	"executionTimeMillis": 1, // è€—æ—¶1ms
	"totalDocsExamined": 1, // æ‰«ææ–‡æ¡£æ€»æ•°1æ¡
	"executionStages": {
		"stage": "FETCH" // æŸ¥æ‰¾ç´¢å¼•
	}
}
```
